<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dynamic Data Table</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            padding: 8px 12px;
            border: 1px solid #ccc;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
        .loading {
            text-align: center;
            margin-top: 20px;
        }
        .progress-bar-container {
            width: 100%;
            background-color: #f2f2f2;
            border-radius: 25px;
            overflow: hidden;
        }
        .progress-bar {
            width: 0%;
            height: 20px;
            background-color: #4caf50;
            text-align: center;
            color: white;
            border-radius: 25px;
        }
    </style>
</head>
<body>
    <h1>Dynamic Data Table</h1>
    <div>
        <label for="trainerName">Trainer Name:</label>
        <select id="trainerName"></select>
    </div>
    <div>
        <label for="date">Date:</label>
        <select id="date"></select>
    </div>
    <button onclick="fetchAndDisplayData()">Go</button>
    <div class="loading" id="loading">
        <div class="progress-bar-container">
            <div class="progress-bar" id="progressBar">0%</div>
        </div>
    </div>
    <div id="tableContainer"></div>

    <script>
        const excludedMemberIds = [15338497, 16288193, 15119005, 1558934, 15337432, 15343252, 15975745, 15343999, 1342000, 15300776, 15341847, 15339393, 15119002, 15341359, 15338258, 15337832, 15338313, 15337323, 16098069, 15343486, 15336512, 15343712, 16288189, 15338496, 15337329, 15340788, 15975071, 15931331, 15913204, 15913221, 16256662, 15341284, 15339006, 1342000, 1342012, 17611091, 18002802, 17962795, 17441424, 17435973, 17128715, 17662843, 17715555, 17611091, 17080950];
        const excludedMembershipTypes = ['Studio Private Class', 'Studio 3 Month Unlimited Membership', 'Studio 12 Class Package', 'Studio 8 Class Package', 'Studio 1 Month Unlimited Membership', 'Studio 2 Week Unlimited Membership', 'Studio Single class', 'Studio Annual Unlimited Membership', 'Studio 2 Week Unlimited', 'Studio 4 Class Package', 'Virtual Private Class', 'Studio 6 Month Unlimited Membership', 'Studio 20 Single Class Pack', 'Studio 10 Single Class Pack', 'Studio Happy Hour Private', 'Studio FLEX 4 Class', 'pay-later', 'Studio Staff/Family Class', 'Studio 8 Class Package', 'Studio 12 Class Package', 'Studio 2 Week Unlimited', 'Studio 20 Single Class Pack', 'Studio 3 Month Unlimited Membership', 'Studio 1 Month Unlimited Membership', 'Studio Single Class', 'Studio Annual Unlimited Membership', 'Studio Newcomers 2 Week Unlimited Membership', 'Studio 4 Class Package', 'V\'Day Special: Shared Studio 8 Class Package '];

        const endpoints = {
            New: [
                'https://reports-api.momence.com/host/13752/reports/new-visitors?timeZone=Asia%2FKolkata&day=2023-09-24&startDate=2023-07-01T18:30:00.000Z&endDate=2025-12-31T18:29:00.000Z',
                'https://reports-api.momence.com/host/33905/reports/new-visitors?timeZone=Asia%2FKolkata&day=2023-09-24&startDate=2023-07-01T18:30:00.000Z&endDate=2025-12-31T18:29:00.000Z'
            ],
        };

        async function authenticateAndGetCookie() {
            const loginPayload = {
                email: 'jimmeey@physique57india.com',
                password: 'Jimmeey@123',
            };

            const response = await fetch('https://api.momence.com/auth/login', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json',
                },
                body: JSON.stringify(loginPayload),
            });

            if (response.status !== 200) {
                console.error('Authentication failed.');
                return null;
            }

            const headers = response.headers;
            const cookie = headers.get('set-cookie');
            return cookie;
        }

        async function fetchDataFromApi(apiUrl, cookie) {
            const response = await fetch(apiUrl, {
                method: 'GET',
                headers: {
                    'Accept': 'application/json',
                    'Cookie': cookie,
                },
            });

            if (response.status !== 200) {
                console.error('Fetching data failed.');
                return null;
            }

            return response.json();
        }

        async function fetchAndDisplayData() {
    document.getElementById('loading').style.display = 'block';
    document.getElementById('progressBar').style.width = '0%';
    document.getElementById('progressBar').innerText = '0%';

    const cookie = await authenticateAndGetCookie();
    if (!cookie) {
        document.getElementById('loading').style.display = 'none';
        return;
    }

    const trainerName = document.getElementById('trainerName').value;
    const date = document.getElementById('date').value;

    let allData = [];
    const totalUrls = endpoints.New.length;
    let processedUrls = 0;

    for (const dataUrl of endpoints.New) {
        const responseData = await fetchDataFromApi(dataUrl, cookie);
        processedUrls++;

        if (responseData) {
            const filteredItems = responseData.items.filter(item => {
                return !(excludedMemberIds.includes(item.memberId) || excludedMembershipTypes.includes(item.membershipUsed) || item.paymentMethod === "pay-later") && item.trainer === trainerName && item.date === date;
            });
            allData = allData.concat(filteredItems);
        }

        // Update progress bar
        const progress = Math.round((processedUrls / totalUrls) * 100);
        document.getElementById('progressBar').style.width = progress + '%';
        document.getElementById('progressBar').innerText = progress + '%';
    }

    document.getElementById('loading').style.display = 'none';
    displayDataInTable(allData);
}


        function displayDataInTable(data) {
            const tableContainer = document.getElementById('tableContainer');
            tableContainer.innerHTML = '';

            if (data.length === 0) {
                tableContainer.innerHTML = '<p>No data found for the selected filters.</p>';
                return;
            }

            const table = document.createElement('table');
            const headerRow = document.createElement('tr');

            const headers = Object.keys(data[0]);
            headers.forEach(header => {
                const th = document.createElement('th');
                th.textContent = header;
                headerRow.appendChild(th);
            });
            table.appendChild(headerRow);

            data.forEach(item => {
                const row = document.createElement('tr');
                headers.forEach(header => {
                    const td = document.createElement('td');
                    td.textContent = item[header];
                    row.appendChild(td);
                });
                table.appendChild(row);
            });

            tableContainer.appendChild(table);
        }

        document.addEventListener('DOMContentLoaded', async () => {
            const cookie = await authenticateAndGetCookie();
            if (!cookie) return;

            let trainerNames = new Set();
            let dates = new Set();

            for (const dataUrl of endpoints.New) {
                const responseData = await fetchDataFromApi(dataUrl, cookie);
                if (!responseData) continue;

                responseData.items.forEach(item => {
                    trainerNames.add(item.trainer);
                    dates.add(item.date);
                });
            }

            trainerNames = [...trainerNames];
            dates = [...dates];

            const trainerSelect = document.getElementById('trainerName');
            trainerNames.forEach(name => {
                const option = document.createElement('option');
                option.value = name;
                option.textContent = name;
                trainerSelect.appendChild(option);
            });

            const dateSelect = document.getElementById('date');
            dates.forEach(date => {
                const option = document.createElement('option');
                option.value = date;
                option.textContent = date;
                dateSelect.appendChild(option);
            });

            document.getElementById('loading').style.display = 'none';
        });
    </script>
</body>
</html>
